<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>k8s v1.24.0搭建高可用(k8s)Kubernetes集群教程 | 叶落花开的博客</title><meta name="keywords" content="K8s,Docker"><meta name="author" content="叶落花开"><meta name="copyright" content="叶落花开"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="背景Kubernetes 1.24新特性 从kubelet中移除dockershim自1.20版本被弃用之后，dockershim组件终于在1.24的kubelet中被删除。从1.24开始，大家需要使用其他受到支持的运行时选项（例如containerd或CRI-O）；如果您选择Docker Engine作为运行时，则需要使用cri-dockerd。  对于kubelet和containerd重要提">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s v1.24.0搭建高可用(k8s)Kubernetes集群教程">
<meta property="og:url" content="https://www.yeluohuakai.com/posts/2022/05/741c30b.html">
<meta property="og:site_name" content="叶落花开的博客">
<meta property="og:description" content="背景Kubernetes 1.24新特性 从kubelet中移除dockershim自1.20版本被弃用之后，dockershim组件终于在1.24的kubelet中被删除。从1.24开始，大家需要使用其他受到支持的运行时选项（例如containerd或CRI-O）；如果您选择Docker Engine作为运行时，则需要使用cri-dockerd。  对于kubelet和containerd重要提">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-05-23T14:07:00.000Z">
<meta property="article:modified_time" content="2022-12-07T06:32:38.571Z">
<meta property="article:author" content="叶落花开">
<meta property="article:tag" content="K8s">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/favicon.png"><link rel="canonical" href="https://www.yeluohuakai.com/posts/2022/05/741c30b"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2f8a615b51582cf280e790200f3527e6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-LB2ZMBR4ZN"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-LB2ZMBR4ZN');
</script><script>(function(){
var el = document.createElement("script");
el.src = "https://lf1-cdn-tos.bytegoofy.com/goofy/ttzz/push.js?18da2b25537eeea1b5c8819ad9a03fc2279abb7e5ff9fdb01a2409cbd77b8f1db3e414cba65c376eba389ba56d9ee0846cad2206506a6529fe6ee21a7373effb434c445cf6444b10ea9756ea44e128a6";
el.id = "ttzz";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(el, s);
})(window)
</script><script async="async" crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6673854567363222"></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":false,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s v1.24.0搭建高可用(k8s)Kubernetes集群教程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-07 14:32:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/index_code.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/ava.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">145</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">71</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://support.qq.com/product/377343"><i class="fa-fw fa fa-paper-plane"></i><span> 反馈</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">叶落花开的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://support.qq.com/product/377343"><i class="fa-fw fa fa-paper-plane"></i><span> 反馈</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">k8s v1.24.0搭建高可用(k8s)Kubernetes集群教程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-23T14:07:00.000Z" title="发表于 2022-05-23 22:07:00">2022-05-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-07T06:32:38.571Z" title="更新于 2022-12-07 14:32:38">2022-12-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91/">服务端开发</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">容器技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span id="" data-flag-title="k8s v1.24.0搭建高可用(k8s)Kubernetes集群教程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h5 id="Kubernetes-1-24新特性"><a href="#Kubernetes-1-24新特性" class="headerlink" title="Kubernetes 1.24新特性"></a>Kubernetes 1.24新特性</h5><ul>
<li>从kubelet中移除dockershim<br>自1.20版本被弃用之后，dockershim组件终于在1.24的kubelet中被删除。从1.24开始，大家需要使用其他受到支持的运行时选项（例如containerd或CRI-O）；如果您选择Docker Engine作为运行时，则需要使用cri-dockerd。</li>
</ul>
<p>对于kubelet和containerd重要提示<br>在升级至1.24之前，请确认containerd版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#以下容器运行时已经或即将全面兼容Kubernetes 1.24：</span><br><span class="line">containerd v1.6.4及更高，v1.5.11及更高</span><br><span class="line">CRI-O 1.24及更高</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">若CNI插件尚未升级且/或CNI配置文件中未声明CNI配置版本时，则containerd v1.6.0-v1.6.3版本将导致Pod CNI网络setup及tear down发生问题。containerd团队报告称，这些问题已经在containerd v1.6.4中得到解决。</span><br><span class="line">在containerd v1.6.0-v1.6.3时，如果你未升级CNI插件且/或声明CNI配置版本，则可能遇到CNI版本不兼容或无法为沙箱删除网络等错误。</span><br></pre></td></tr></table></figure>

<h2 id="Kubernetes-1-24新特性-1"><a href="#Kubernetes-1-24新特性-1" class="headerlink" title="Kubernetes 1.24新特性"></a>Kubernetes 1.24新特性</h2><ul>
<li><p>各beta API默认关闭<br>在默认情况下，新的各beta API不会在集群内得到启用。但全部原有beta API及其新版本将在1.24中继续默认启用</p>
</li>
<li><p>OpenAPI v3<br>Kubernetes 1.24开始为API的OpenAPI v3发布格式提供beta支持。</p>
</li>
<li><p>存储容量与存储卷扩展双双迎来通用版本<br>存储容量跟踪通过CSIStorageCapacity对象公开当前可用的存储容量，并对使用后续绑定的CSI存储卷的pod进行调度增强。<br>存储卷扩展则新增对现有持久卷的重新调整功能。</p>
</li>
<li><p>NonPreemptingPriority迎来稳定版<br>此功能为PriorityClasses添加了新的选项，可开启或关闭Pod抢占机制</p>
</li>
<li><p>存储插件迁移<br>目前Kubernetes开发团队正在迁移树内存储插件，希望在实现CSI插件的同时、保持原有API的正常起效。Azure Disk与OpenStack Cinder等插件已经完成了迁移。</p>
</li>
<li><p>gRPC探针升级至beta版<br>在1.24版本中，gRPC探针功能已经进入beta阶段且默认启用。现在，大家可以在Kubernetes中为自己的gRPC应用程序原生配置启动、活动与就绪探测，而且无需公开HTTP商战或者使用额外的可执行文件。</p>
</li>
<li><p>Kubelet证书提供程序升级至beta版<br>最初在Kubernetes 1.20版本中以alpha版亮相的kubelet镜像证书提供程序现已升级至beta版。现在，kubelet将使用exec插件动态检索容器镜像注册表的凭证，而不再将凭证存储在节点文件系统之上。</p>
</li>
<li><p>避免为服务分配IP时发生冲突<br>Kubernetes 1.24引入了一项新的选择性功能，允许用户为服务的静态IP分配地址保留一个软范围。通过手动启用此项功能，集群将从您指定的服务IP池中自动获取地址，从而降低冲突风险。  </p>
</li>
</ul>
<p>也就是说，服务的ClusterIP能够以下列方式分配：<br><strong>动态分配</strong>，即集群将在配置的服务IP范围内自动选择一个空闲IP。<br><strong>静态分配</strong>，意味着用户需要在已配置的服务IP范围内指定一个IP。  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">服务ClusterIP是唯一的；因此若尝试使用已被分配的ClusterIP进行服务创建，则会返回错误结果。</span><br></pre></td></tr></table></figure>

<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>我本地有kubernetes 1.18环境，接下来对环境进行初始化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#目前kubernetes版本</span><br><span class="line">[root@k8s-01 ~]# kubectl  get node</span><br><span class="line">NAME     STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-01   Ready    master   243d   v1.18.3</span><br><span class="line">k8s-02   Ready    master   243d   v1.18.3</span><br><span class="line">k8s-03   Ready    master   243d   v1.18.3</span><br><span class="line">k8s-04   Ready    &lt;none&gt;   243d   v1.18.3</span><br><span class="line">k8s-05   Ready    &lt;none&gt;   243d   v1.18.3</span><br></pre></td></tr></table></figure>

<p>卸载集群命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#建议所有服务器都执行</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubeadm reset -f</span><br><span class="line">modprobe -r ipip</span><br><span class="line">lsmod</span><br><span class="line">rm -rf ~/.kube/</span><br><span class="line">rm -rf /etc/kubernetes/</span><br><span class="line">rm -rf /etc/systemd/system/kubelet.service.d</span><br><span class="line">rm -rf /etc/systemd/system/kubelet.service</span><br><span class="line">rm -rf /usr/bin/kube*</span><br><span class="line">rm -rf /etc/cni</span><br><span class="line">rm -rf /opt/cni</span><br><span class="line">rm -rf /var/lib/etcd</span><br><span class="line">rm -rf /var/etcd</span><br><span class="line">yum -y remove kubeadm* kubectl* kubelet* docker*</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h2 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h2><table>
<thead>
<tr>
<th>IP地址</th>
<th>主机名</th>
<th>服务</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.31.10</td>
<td>k8s-01</td>
<td>k8s-master、containerd、keepalived、nginx</td>
<td>2c8g</td>
</tr>
<tr>
<td>192.168.31.11</td>
<td>k8s-02</td>
<td>k8s-master、containerd、keepalived、nginx</td>
<td>2c8g</td>
</tr>
<tr>
<td>192.168.31.12</td>
<td>k8s-03</td>
<td>k8s-master、containerd、keepalived、nginx</td>
<td>2c8g</td>
</tr>
<tr>
<td>192.168.31.13</td>
<td>k8s-04</td>
<td>k8s-node、containerd</td>
<td>1c4g</td>
</tr>
<tr>
<td>192.168.31.14</td>
<td>k8s-05</td>
<td>k8s-node、containerd</td>
<td>1c4g</td>
</tr>
<tr>
<td>VIP: 192.168.31.111 域名:apiserver.frps.cn</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>apiserver.frps.cn:6443 为VIP</p>
<ul>
<li>kube-apiserver 三台节点</li>
<li>kube-schedulet 三台节点</li>
<li>kube-controller-manager 三台节点</li>
<li>ETCD 三台节点</li>
</ul>
<h5 id="服务版本"><a href="#服务版本" class="headerlink" title="服务版本"></a>服务版本</h5><table>
<thead>
<tr>
<th>服务名称</th>
<th>版本号</th>
</tr>
</thead>
<tbody><tr>
<td>内核</td>
<td>5.14.3-1.el7.elrepo.x86_64</td>
</tr>
<tr>
<td>containerd</td>
<td>v1.6.4</td>
</tr>
<tr>
<td>ctr</td>
<td>v1.6.4</td>
</tr>
<tr>
<td>k8s</td>
<td>1.24</td>
</tr>
</tbody></table>
<h5 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">初始化环境需要全部节点都执行</span><br></pre></td></tr></table></figure>

<p>批量修改主机名，以及免密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hostnamectl set-hostname k8s01  #所有机器按照要求修改</span><br><span class="line">bash        #刷新主机名</span><br><span class="line">#配置host</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">192.168.31.10  k8s-01</span><br><span class="line">192.168.31.11  k8s-02</span><br><span class="line">192.168.31.12  k8s-03</span><br><span class="line">192.168.31.13  k8s-04</span><br><span class="line">192.168.31.14  k8s-05</span><br><span class="line">EOF</span><br><span class="line">#设置k8s-01为分发机 (只需要在k8s-01服务器操作即可)</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum install -y expect</span><br><span class="line">#分发公钥</span><br><span class="line">ssh-keygen -t rsa -P &quot;&quot; -f /root/.ssh/id_rsa</span><br><span class="line">for i in k8s-01 k8s-02 k8s-03 k8s-04 k8s-05;do</span><br><span class="line">expect -c &quot;</span><br><span class="line">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$i</span><br><span class="line">        expect &#123;</span><br><span class="line">                &quot;*yes/no*&quot; &#123;send &quot;yesr&quot;; exp_continue&#125;</span><br><span class="line">                &quot;*password*&quot; &#123;send &quot;123456r&quot;; exp_continue&#125;</span><br><span class="line">                &quot;*Password*&quot; &#123;send &quot;123456r&quot;;&#125;</span><br><span class="line">        &#125; &quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我这里密码为123456，请根据需求自行更改  </p>
</blockquote>
<p>所有节点关闭Selinux、iptables、swap分区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i &#x27;/ swap / s/^(.*)$/#1/g&#x27; /etc/fstab</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<p>所有节点配置yum源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<p>新安装的服务器可以安装下面的软件包，可以解决99%的依赖问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make autoconf libtool-ltdl-devel gd-devel freetype-devel libxml2-devel libjpeg-devel libpng-devel openssh-clients openssl-devel curl-devel bison patch libmcrypt-devel libmhash-devel ncurses-devel binutils compat-libstdc++-33 elfutils-libelf elfutils-libelf-devel glibc glibc-common glibc-devel libgcj libtiff pam-devel libicu libicu-devel gettext-devel libaio-devel libaio libgcc libstdc++ libstdc++-devel unixODBC unixODBC-devel numactl-devel glibc-headers sudo bzip2 mlocate flex lrzsz sysstat lsof setuptool system-config-network-tui system-config-firewall-tui ntsysv ntp pv lz4 dos2unix unix2dos rsync dstat iotop innotop mytop telnet iftop expect cmake nc gnuplot screen xorg-x11-utils xorg-x11-xinit rdate bc expat-devel compat-expat1 tcpdump sysstat man nmap curl lrzsz elinks finger bind-utils traceroute mtr ntpdate zip unzip vim wget net-tools</span><br></pre></td></tr></table></figure>

<p>由于开启内核 ipv4 转发需要加载 br_netfilter 模块，所以加载下该模块：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">modprobe ip_conntrack</span><br><span class="line">#每台节点</span><br></pre></td></tr></table></figure>

<p>将上面的命令设置成开机启动，因为重启后模块失效，下面是开机自动加载模块的方式。首先新建 /etc/rc.sysinit 文件，内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt;&gt;/etc/rc.sysinit&lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">for file in /etc/sysconfig/modules/*.modules ; do</span><br><span class="line">[ -x $file ] &amp;&amp; $file</span><br><span class="line">done</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>然后在/etc/sysconfig/modules/目录下新建如下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;modprobe br_netfilter&quot; &gt;/etc/sysconfig/modules/br_netfilter.modules</span><br><span class="line">echo &quot;modprobe ip_conntrack&quot; &gt;/etc/sysconfig/modules/ip_conntrack.modules</span><br></pre></td></tr></table></figure>

<p>增加权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chmod 755 /etc/sysconfig/modules/br_netfilter.modules</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ip_conntrack.modules</span><br></pre></td></tr></table></figure>

<p>然后重启后，模块就可以自动加载了</p>
<p>优化内核参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br><span class="line">vm.overcommit_memory=1 # 不检查物理内存是否够用</span><br><span class="line">vm.panic_on_oom=0 # 开启 OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br><span class="line">#分发到所有节点</span><br><span class="line">for i in k8s-02 k8s-03 k8s-04 k8s-05</span><br><span class="line">do</span><br><span class="line">    scp kubernetes.conf root@$i:/etc/sysctl.d/</span><br><span class="line">    ssh root@$i sysctl -p /etc/sysctl.d/kubernetes.conf</span><br><span class="line">    ssh root@$i echo &#x27;1&#x27; &gt;&gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">done</span><br><span class="line">#for后面节点根据需求修改</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bridge-nf 使得netfilter可以对Linux网桥上的 IPv4/ARP/IPv6 包过滤。比如，设置net.bridge.bridge-nf-call-iptables＝1后，二层的网桥在转发包时也会被 iptables的 FORWARD 规则所过滤。常用的选项包括：</p>
</blockquote>
<blockquote>
<blockquote>
<p>net.bridge.bridge-nf-call-arptables：是否在 arptables 的 FORWARD 中过滤网桥的 ARP 包<br>net.bridge.bridge-nf-call-ip6tables：是否在 ip6tables 链中过滤 IPv6 包<br>net.bridge.bridge-nf-call-iptables：是否在 iptables 链中过滤 IPv4 包<br>net.bridge.bridge-nf-filter-vlan-tagged：是否在 iptables/arptables 中过滤打了 vlan 标签的包。  </p>
</blockquote>
</blockquote>
<p>所有节点安装ipvs</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#为什么要使用IPVS,从k8s的1.8版本开始，kube-proxy引入了IPVS模式，IPVS模式与iptables同样基于Netfilter，但是采用的hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。</span><br><span class="line">ipvs依赖于nf_conntrack_ipv4内核模块,4.19包括之后内核里改名为nf_conntrack,1.13.1之前的kube-proxy的代码里没有加判断一直用的nf_conntrack_ipv4,好像是1.13.1后的kube-proxy代码里增加了判断,我测试了是会去load nf_conntrack使用ipvs正常</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">#查看是否已经正确加载所需的内核模块</span><br></pre></td></tr></table></figure>

<p>所有节点安装ipset</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install ipset -y</span><br></pre></td></tr></table></figure>

<p>ipset介绍</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables是Linux服务器上进行网络隔离的核心技术，内核在处理网络请求时会对iptables中的策略进行逐条解析，因此当策略较多时效率较低；而是用IPSet技术可以将策略中的五元组(协议，源地址，源端口,目的地址，目的端口)合并到有限的集合中，可以大大减少iptables策略条目从而提高效率。测试结果显示IPSet方式效率将比iptables提高100倍</span><br></pre></td></tr></table></figure>

<p>为了方面ipvs管理，这里安装一下ipvsadm。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br></pre></td></tr></table></figure>

<p>所有节点设置系统时区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"> #将当前的 UTC 时间写入硬件时钟</span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"> #重启依赖于系统时间的服务</span><br><span class="line">systemctl restart rsyslog </span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<p>升级内核 (可选方案)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line">#默认安装为最新内核</span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml</span><br><span class="line">#修改内核顺序</span><br><span class="line">grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">#使用下面命令看看确认下是否启动默认内核指向上面安装的内核</span><br><span class="line">grubby --default-kernel</span><br><span class="line">#这里的输出结果应该为我们升级后的内核信息</span><br><span class="line">reboot</span><br><span class="line">#可以等所有初始化步骤结束进行reboot操作</span><br></pre></td></tr></table></figure>

<p>接下来更新一下软件包版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<h2 id="Containerd-安装"><a href="#Containerd-安装" class="headerlink" title="Containerd 安装"></a>Containerd 安装</h2><p>在安装containerd前，我们需要优先升级libseccomp<br>在centos7中yum下载libseccomp的版本是2.3的，版本不满足我们最新containerd的需求，需要下载2.4以上的</p>
<blockquote>
<p><strong>Containerd需要在所有节点升级安装</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#卸载原来的</span><br><span class="line">[i4t@web01 ~]# rpm -qa | grep libseccomp</span><br><span class="line">libseccomp-devel-2.3.1-4.el7.x86_64</span><br><span class="line">libseccomp-2.3.1-4.el7.x86_64</span><br><span class="line">[i4t@web01 ~]# rpm -e libseccomp-devel-2.3.1-4.el7.x86_64 --nodeps</span><br><span class="line">[i4t@web01 ~]# rpm -e libseccomp-2.3.1-4.el7.x86_64 --nodeps</span><br><span class="line">#下载高于2.4以上的包</span><br><span class="line">[i4t@web01 ~]# wget http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line">#安装</span><br><span class="line">[i4t@web01 ~]# rpm -ivh libseccomp-2.5.1-1.el8.x86_64.rpm </span><br><span class="line">warning: libseccomp-2.5.1-1.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span><br><span class="line">Preparing...                          ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:libseccomp-2.5.1-1.el8           ################################# [100%]</span><br><span class="line">#查看当前版本</span><br><span class="line">[root@web01 ~]# rpm -qa | grep libseccomp</span><br><span class="line">libseccomp-2.5.1-1.el8.x86_64</span><br></pre></td></tr></table></figure>

<h5 id="下载安装containerd"><a href="#下载安装containerd" class="headerlink" title="下载安装containerd"></a>下载安装containerd</h5><p>github地址:<a target="_blank" rel="noopener" href="https://containerd.io/downloads/">https://containerd.io/downloads/</a></p>
<p>Containerd安装我们使用<strong>1.6.1</strong>版本号</p>
<blockquote>
<p>containerd-1.6.1-linux-amd64.tar.gz 只包含containerd<br>cri-containerd-cni-1.6.4-linux-amd64.tar.gz 包含containerd以及cri runc等相关工具包，建议下载本包</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#下载tar.gz包</span><br><span class="line">#containerd工具包，包含cri runc等</span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br><span class="line">#备用下载地址</span><br><span class="line">wget https://d.frps.cn/file/kubernetes/containerd/cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>工具包文件如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#cri-containerd-cni会将我们整个containerd相关的依赖都进行下载下来</span><br><span class="line">[root@k8s-01 containerd]# tar zxvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz -C /   #我们直接让它给我们对应的目录给替换掉</span><br><span class="line">etc/</span><br><span class="line">etc/systemd/</span><br><span class="line">etc/systemd/system/</span><br><span class="line">etc/systemd/system/containerd.service</span><br><span class="line">etc/crictl.yaml</span><br><span class="line">etc/cni/</span><br><span class="line">etc/cni/net.d/</span><br><span class="line">etc/cni/net.d/10-containerd-net.conflist</span><br><span class="line">usr/</span><br><span class="line">usr/local/</span><br><span class="line">usr/local/sbin/</span><br><span class="line">usr/local/sbin/runc</span><br><span class="line">usr/local/bin/</span><br><span class="line">usr/local/bin/crictl</span><br><span class="line">usr/local/bin/ctd-decoder</span><br><span class="line">usr/local/bin/ctr</span><br><span class="line">usr/local/bin/containerd-shim</span><br><span class="line">usr/local/bin/containerd</span><br><span class="line">usr/local/bin/containerd-shim-runc-v1</span><br><span class="line">usr/local/bin/critest</span><br><span class="line">usr/local/bin/containerd-shim-runc-v2</span><br><span class="line">usr/local/bin/containerd-stress</span><br><span class="line">opt/</span><br><span class="line">opt/containerd/</span><br><span class="line">opt/containerd/cluster/</span><br><span class="line">opt/containerd/cluster/version</span><br><span class="line">opt/containerd/cluster/gce/</span><br><span class="line">opt/containerd/cluster/gce/cni.template</span><br><span class="line">opt/containerd/cluster/gce/env</span><br><span class="line">opt/containerd/cluster/gce/configure.sh</span><br><span class="line">opt/containerd/cluster/gce/cloud-init/</span><br><span class="line">opt/containerd/cluster/gce/cloud-init/node.yaml</span><br><span class="line">opt/containerd/cluster/gce/cloud-init/master.yaml</span><br><span class="line">opt/cni/</span><br><span class="line">opt/cni/bin/</span><br><span class="line">opt/cni/bin/firewall</span><br><span class="line">opt/cni/bin/portmap</span><br><span class="line">opt/cni/bin/host-local</span><br><span class="line">opt/cni/bin/ipvlan</span><br><span class="line">opt/cni/bin/host-device</span><br><span class="line">opt/cni/bin/sbr</span><br><span class="line">opt/cni/bin/vrf</span><br><span class="line">opt/cni/bin/static</span><br><span class="line">opt/cni/bin/tuning</span><br><span class="line">opt/cni/bin/bridge</span><br><span class="line">opt/cni/bin/macvlan</span><br><span class="line">opt/cni/bin/bandwidth</span><br><span class="line">opt/cni/bin/vlan</span><br><span class="line">opt/cni/bin/dhcp</span><br><span class="line">opt/cni/bin/loopback</span><br><span class="line">opt/cni/bin/ptp</span><br></pre></td></tr></table></figure>

<p>上面的文件都是二进制文件，直接移动到对应的目录并配置好环境变量就可以进行使用了。</p>
<p>如果我们机器上通过yum安装docker了，可以用下面的命令进行卸载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum remove docker </span><br><span class="line">                  docker-client </span><br><span class="line">                  docker-client-latest </span><br><span class="line">                  docker-common </span><br><span class="line">                  docker-latest </span><br><span class="line">                  docker-latest-logrotate </span><br><span class="line">                  docker-logrotate </span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>

<p>接下来我们为每台服务器配置Containerd</p>
<p>#创建配置文件目录<br>[root@k8s-01 ~]# mkdir /etc/containerd -p<br>#生成默认配置文件<br>[root@k8s-01 ~]# containerd config default &gt; /etc/containerd/config.toml<br>#–config,-c可以在启动守护程序时更改此路径<br>#配置文件的默认路径位于/etc/containerd/config.toml<br>替换默认pause镜像地址</p>
<p>默认情况下k8s.gcr.io无法访问，所以使用我提供的阿里云镜像仓库地址即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/k8s.gcr.io/registry.cn-beijing.aliyuncs.com/abcdocker/&#x27; /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">#所有节点更换默认镜像地址</span><br><span class="line">#我这里使用阿里云地址</span><br></pre></td></tr></table></figure>

<p>配置systemd作为容器的cgroup driver</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/SystemdCgroup = false/SystemdCgroup = true/&#x27; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>

<p>Containerd官方操作手册</p>
<p>默认cri-containerd-cni包中会有containerd启动脚本，我们已经解压到对应的目录，可以直接调用启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# systemctl enable containerd --now   </span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/containerd.service to /etc/systemd/system/containerd.service.</span><br><span class="line">[root@k8s-01 ~]# systemctl status containerd   #查看containerd启动状态</span><br><span class="line">● containerd.service - containerd container runtime</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/containerd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2022-05-12 22:59:19 EDT; 3s ago</span><br><span class="line">     Docs: https://containerd.io</span><br><span class="line">  Process: 30048 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 30050 (containerd)</span><br><span class="line">   Memory: 24.5M</span><br><span class="line">   CGroup: /system.slice/containerd.service</span><br><span class="line">           └─30050 /usr/local/bin/containerd</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.153514446-04:00&quot; level=info msg=&quot;Get image filesystem path &quot;/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs&quot;&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154085898-04:00&quot; level=info msg=&quot;Start subscribing containerd event&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154137039-04:00&quot; level=info msg=&quot;Start recovering state&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154230615-04:00&quot; level=info msg=&quot;Start event monitor&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154276701-04:00&quot; level=info msg=&quot;Start snapshots syncer&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154299287-04:00&quot; level=info msg=&quot;Start cni network conf syncer for default&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154316094-04:00&quot; level=info msg=&quot;Start streaming server&quot;</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154675632-04:00&quot; level=info msg=serving... address=/run/containerd/containerd.sock.ttrpc</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.154755704-04:00&quot; level=info msg=serving... address=/run/containerd/containerd.sock</span><br><span class="line">May 12 22:59:19 web01 containerd[30050]: time=&quot;2022-05-12T22:59:19.155220379-04:00&quot; level=info msg=&quot;containerd successfully booted in 0.027654s&quot;</span><br></pre></td></tr></table></figure>

<p>ctr在我们解压包中已经附带了，直接可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# ctr version</span><br><span class="line">Client:     #ctr版本号</span><br><span class="line">  Version:  v1.6.4</span><br><span class="line">  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16</span><br><span class="line">  Go version: go1.17.9</span><br><span class="line">Server:</span><br><span class="line">  Version:  v1.6.4     #containerd版本号</span><br><span class="line">  Revision: 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16</span><br><span class="line">  UUID: b376d7b6-c97e-4b39-8144-9624ade3ba84</span><br><span class="line">#可以使用下面命令查看containerd版本号</span><br><span class="line">[root@k8s-01 ~]# containerd --version</span><br><span class="line">containerd github.com/containerd/containerd v1.6.4 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16</span><br></pre></td></tr></table></figure>

<h2 id="Kubeadm-安装配置"><a href="#Kubeadm-安装配置" class="headerlink" title="Kubeadm 安装配置"></a>Kubeadm 安装配置</h2><p>首先我们需要在k8s-01配置kubeadm源</p>
<blockquote>
<p>下面kubeadm操作只需要在k8s-01上即可</p>
</blockquote>
<p>国内源</p>
<p>packages.cloud.google.com这里懂的都懂，下面改成阿里云源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>官方文档推荐源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>k8s-01节点安装kubeadm和master相关依赖组建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y kubelet-1.24.0 kubeadm-1.24.0 kubectl-1.24.0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>

<p>将k8s-01节点的kubelet设置成开机启动：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<p>配置kubeadm文件</p>
<p>这里我们在k8s-01上配置打印init默认配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt;kubeadm-init.yaml</span><br></pre></td></tr></table></figure>

<p>虽然kubeadm作为etcd节点的管理工具，但请注意kubeadm不打算支持此类节点的证书轮换或升级。长期计划是使用etcdadm来工具来进行管理。</p>
<p>因为我这里要做集群，请根据我这里的配置按需修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# cat kubeadm-init.yaml </span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.31.10               #k8s-01 ip地址</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: unix:///var/run/containerd/containerd.sock</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  name: k8s-01</span><br><span class="line">  taints: null</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">etcd:</span><br><span class="line">    local:</span><br><span class="line">      dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: 1.24.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs                                            # kube-proxy 模式</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 0s</span><br><span class="line">    cacheUnauthorizedTTL: 0s</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">cpuManagerReconcilePeriod: 0s</span><br><span class="line">evictionPressureTransitionPeriod: 0s</span><br><span class="line">fileCheckFrequency: 0s</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 0s</span><br><span class="line">imageMinimumGCAge: 0s</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: systemd                   # 配置 cgroup driver</span><br><span class="line">logging: &#123;&#125;</span><br><span class="line">memorySwap: &#123;&#125;</span><br><span class="line">nodeStatusReportFrequency: 0s</span><br><span class="line">nodeStatusUpdateFrequency: 0s</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 0s</span><br><span class="line">shutdownGracePeriod: 0s</span><br><span class="line">shutdownGracePeriodCriticalPods: 0s</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 0s</span><br><span class="line">syncFrequency: 0s</span><br><span class="line">volumeStatsAggPeriod: 0s</span><br></pre></td></tr></table></figure>

<p>检查配置文件是否有错误</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# kubeadm init --config kubeadm-init.yaml --dry-run</span><br></pre></td></tr></table></figure>

<p>正确如下</p>
<p>1652881108147.png</p>
<p>预先拉取镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# kubeadm config images list --config kubeadm-init.yaml </span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.24.0</span><br><span class="line">k8s.gcr.io/pause:3.7</span><br><span class="line">k8s.gcr.io/etcd:3.5.3-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.6</span><br></pre></td></tr></table></figure>

<p>提前下载镜像导入，默认情况使用的是k8s.gcr.io，这个镜像地址我们无法pull，所以使用导入的方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://d.frps.cn/file/kubernetes/image/k8s_all_1.24.tar</span><br><span class="line">#拷贝到其它节点</span><br><span class="line">for i in k8s-02 k8s-03 k8s-04 k8s-05;do</span><br><span class="line">    scp k8s_all_1.24.tar root@$i:/root/</span><br><span class="line">    ssh root@$i ctr -n k8s.io i import k8s_all_1.24.tar</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# ctr -n k8s.io i ls -q</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.6</span><br><span class="line">k8s.gcr.io/etcd:3.5.3-0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.24.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.24.0</span><br><span class="line">k8s.gcr.io/pause:3.7</span><br></pre></td></tr></table></figure>

<h2 id="Kubectl-安装"><a href="#Kubectl-安装" class="headerlink" title="Kubectl 安装"></a>Kubectl 安装</h2><p>这一步可以省略，可以通过后续yum安装，这一步可以忽略</p>
<blockquote>
<p>kubeadm不会安装或管理kubelet，kubectl因此需要确保它们kubeadm和Kubernetes版本相匹配。如果不这样，则存在版本偏差的风险。但是，支持kubelet和k8s之间的一个小版本偏差，但kubelet版本可能永远不会超过API Server版本</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#下载1.24.0 kubectl工具</span><br><span class="line">[root@k8s-01 ~]# curl -LO https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubectl</span><br><span class="line">[root@k8s-01 ~]# chmod +x kubectl &amp;&amp; mv kubectl /usr/local/bin/</span><br><span class="line">#检查kubectl工具版本号</span><br><span class="line">[root@k8s-01 ~]# kubectl version --client --output=yaml</span><br><span class="line">clientVersion:</span><br><span class="line">  buildDate: &quot;2022-05-03T13:46:05Z&quot;</span><br><span class="line">  compiler: gc</span><br><span class="line">  gitCommit: 4ce5a8954017644c5420bae81d72b09b735c21f0</span><br><span class="line">  gitTreeState: clean</span><br><span class="line">  gitVersion: v1.24.0</span><br><span class="line">  goVersion: go1.18.1</span><br><span class="line">  major: &quot;1&quot;</span><br><span class="line">  minor: &quot;24&quot;</span><br><span class="line">  platform: linux/amd64</span><br><span class="line">kustomizeVersion: v4.5.4</span><br><span class="line">#拷贝kubectl到其它master节点</span><br><span class="line">for i in k8s-02 k8s-03;do</span><br><span class="line">    scp /usr/local/bin/kubectl root@$i:/usr/local/bin/kubectl</span><br><span class="line">    ssh root@$i chmod +x /usr/local/bin/kubectl</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>接下来开始初始化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]#  kubeadm init --config kubeadm-init.yaml  --upload-certs</span><br></pre></td></tr></table></figure>

<p>初始化过程</p>
<img src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/dong706/dong706.github.io@latest/images/pasted-34.png" alt="">

<p>初始化完成</p>
<img src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/dong706/dong706.github.io@latest/images/pasted-35.png" alt="">

<p>记住init后打印的token，复制kubectl的kubeconfig，kubectl的kubeconfig路径默认是~/.kube/config</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<p>初始化的配置文件为保存在configmap里面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system get cm kubeadm-config -o yaml</span><br></pre></td></tr></table></figure>

<p>接下来执行kubectl就可以看到node了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# kubectl get node</span><br><span class="line">NAME     STATUS   ROLES           AGE     VERSION</span><br><span class="line">k8s-01   Ready    control-plane   4m18s   v1.24.0</span><br></pre></td></tr></table></figure>

<h2 id="Master节点配置"><a href="#Master节点配置" class="headerlink" title="Master节点配置"></a>Master节点配置</h2><p>前面我们已经为所有master节点配置了一下服务</p>
<ul>
<li>nginx</li>
<li>keeplived</li>
<li>containerd </li>
</ul>
<p>接下来只需要给其它master节点安装k8s组件  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>安装相关组件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y kubelet-1.24.0 kubeadm-1.24.0 kubectl-1.24.0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>

<p>启动kubelet</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<p>master执行添加节点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm join apiserver.frps.cn:8443 --token abcdef.0123456789abcdef </span><br><span class="line">        --discovery-token-ca-cert-hash sha256:a54c17e514edba57226f969268227b749d8bfb8802ae99112e08cbcabcd22ae0 </span><br><span class="line">        --control-plane --certificate-key f7b0eb9c7e0aac2c95eef083c591950109434250a6df9cc0dc1ec9fb04461250</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">设置kubectl config文件</span><br></pre></td></tr></table></figure>

<p>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">目前我们3台master节点已经添加完毕</span><br></pre></td></tr></table></figure>

<p>[root@k8s-02 ~]# kubectl get node<br>NAME     STATUS   ROLES           AGE     VERSION<br>k8s-01   Ready    control-plane   15m     v1.24.0<br>k8s-02   Ready    control-plane   6m25s   v1.24.0<br>k8s-03   Ready    control-plane   14m     v1.24.0</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## Node节点配置</span><br><span class="line">##### node节点安装kubeadm</span><br></pre></td></tr></table></figure>

<p>cat &lt;<EOF > /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=<a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64">http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</a><br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=<a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg">http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</a><br>        <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</a><br>EOF</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">##### 安装相关组件</span><br></pre></td></tr></table></figure>

<p>yum install -y kubeadm-1.24.0 –disableexcludes=kubernetes</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">添加join命令</span><br></pre></td></tr></table></figure>

<p>kubeadm join apiserver.frps.cn:8443 –token abcdef.0123456789abcdef<br>        –discovery-token-ca-cert-hash sha256:a54c17e514edba57226f969268227b749d8bfb8802ae99112e08cbcabcd22ae0 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果我们后续需要添加node节点时，可以到k8s-01节点执行下面的命令获取token相关信息</span><br></pre></td></tr></table></figure>

<p>[root@k8s-01 ~]# kubeadm token create –print-join-command<br>kubeadm join apiserver.frps.cn:8443 –token sgvcen.qf87ykht9gopqe0d –discovery-token-ca-cert-hash sha256:f535fdf0af19022a30760fd5069c648019a3f4b4828bfb2eb566224d76d21647 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果我们添加某台节点异常了，修改后可以执行下面的命令，然后在重新join加入集群</span><br></pre></td></tr></table></figure>

<p>kubeadm reset</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">验证所有服务器是否添加到集群中</span><br></pre></td></tr></table></figure>

<p>[root@k8s-01 ~]# kubectl get node -o wide<br>NAME     STATUS   ROLES           AGE    VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME<br>k8s-01   Ready    control-plane   22m    v1.24.0   192.168.31.10   <none>        CentOS Linux 7 (Core)   5.17.8-1.el7.elrepo.x86_64    containerd://1.6.4<br>k8s-02   Ready    control-plane   13m    v1.24.0   192.168.31.11   <none>        CentOS Linux 7 (Core)   5.17.8-1.el7.elrepo.x86_64    containerd://1.6.4<br>k8s-03   Ready    control-plane   21m    v1.24.0   192.168.31.12   <none>        CentOS Linux 7 (Core)   5.17.8-1.el7.elrepo.x86_64    containerd://1.6.4<br>k8s-04   Ready    <none>          107s   v1.24.0   192.168.31.13   <none>        CentOS Linux 7 (Core)   5.17.8-1.el7.elrepo.x86_64    containerd://1.6.4<br>k8s-05   Ready    <none>          6m6s   v1.24.0   192.168.31.14   <none>        CentOS Linux 7 (Core)   3.10.0-1160.62.1.el7.x86_64   containerd://1.6.4</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## 网络配置</span><br><span class="line">这个时候其实集群还不能正常使用，因为还没有安装网络插件，接下来安装网络插件，可以在文档 https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/ 中选择我们自己的网络插件，这里我们安装 flannel</span><br></pre></td></tr></table></figure>

<p>wget <a target="_blank" rel="noopener" href="http://down.i4t.com/k8s1.24/kube-flannel.yml">http://down.i4t.com/k8s1.24/kube-flannel.yml</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">根据需求修改网卡配置，我这里以ens160为主</span><br></pre></td></tr></table></figure>

<pre><code>  containers:
  - name: kube-flannel
    image: quay.io/coreos/flannel:v0.12.0-amd64
    command:
    - /opt/bin/flanneld
    args:
    - --ip-masq
    - --kube-subnet-mgr
    - --iface=ens160  # 如果是多网卡的话，指定内网网卡的名称
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">温馨提示: 在kubeadm.yaml文件中设置了podSubnet网段，同时在flannel中网段也要设置相同的。 （我这里默认就是相同的配置）</span><br><span class="line"></span><br><span class="line">执行</span><br></pre></td></tr></table></figure>

<p>[root@k8s-01 ~]# kubectl apply -f kube-flannel.yml </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## CNI插件问题</span><br><span class="line">默认情况下containerd也会有一个cni插件，但是我们已经安装Flannel了，我们需要使用Flannel的cni插件，需要将containerd里面的cni配置文件进行注释，否则2个配置会产生冲突</span><br><span class="line"></span><br><span class="line">因为如果这个目录中有多个 cni 配置文件，kubelet 将会使用按文件名的字典顺序排列的第一个作为配置文件，所以前面默认选择使用的是 containerd-net 这个插件。</span><br></pre></td></tr></table></figure>

<p>mv /etc/cni/net.d/10-containerd-net.conflist /etc/cni/net.d/10-containerd-net.conflist.bak<br>ifconfig cni0 down &amp;&amp; ip link delete cni0<br>systemctl daemon-reload<br>systemctl restart containerd kubelet</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">接下来我们所有的pod都可以正常运行了</span><br><span class="line"></span><br><span class="line">&#123;% asset_img pasted-36.png  %&#125;</span><br><span class="line"></span><br><span class="line">##### 验证集群</span><br><span class="line">等kube-system命名空间下的Pod都为Running，这里先测试一下dns是否正常</span><br></pre></td></tr></table></figure>

<p>cat&lt;&lt;EOF | kubectl apply -f -<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:<br>      - image: nginx:alpine<br>        name: nginx<br>        ports:<br>        - containerPort: 80</p>
<hr>
<p>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: nginx<br>spec:<br>  selector:<br>    app: nginx<br>  type: NodePort<br>  ports:<br>    - protocol: TCP<br>      port: 80<br>      targetPort: 80<br>      nodePort: 30001</p>
<hr>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: busybox<br>  namespace: default<br>spec:<br>  containers:</p>
<ul>
<li>name: busybox<br>image: abcdocker9/centos:v1<br>command:<ul>
<li>sleep</li>
<li>“3600”<br>imagePullPolicy: IfNotPresent<br>restartPolicy: Always<br>EOF<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">创建后Pod我们进行检查</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<img src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/dong706/dong706.github.io@latest/images/pasted-37.png" alt="">

<p>使用nslookup查看是否能返回地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-01 ~]# kubectl exec -ti busybox -- nslookup kubernetes</span><br><span class="line">Server:         10.96.0.10</span><br><span class="line">Address:        10.96.0.10#53</span><br><span class="line">Name:   kubernetes.default.svc.cluster.local</span><br><span class="line">Address: 10.96.0.1</span><br></pre></td></tr></table></figure>

<p>测试nginx svc以及Pod内部网络通信是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for i in k8s-01 k8s-02 k8s-03 k8s-04 k8s-05</span><br><span class="line">do</span><br><span class="line">   ssh root@$i curl -s 10.99.209.220   #nginx svc ip</span><br><span class="line">   ssh root@$i curl -s 10.244.3.4   #pod ip</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>访问宿主机nodePort端口</p>
<img src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/dong706/dong706.github.io@latest/images/pasted-38.png" alt="">

<blockquote>
<p>转载自 <a target="_blank" rel="noopener" href="https://i4t.com/5451.html">https://i4t.com/5451.html</a> ，进行了一些勘误。如侵权，请联系删除。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">叶落花开</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.yeluohuakai.com/posts/2022/05/741c30b.html">https://www.yeluohuakai.com/posts/2022/05/741c30b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.yeluohuakai.com" target="_blank">叶落花开的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/K8s/">K8s</a><a class="post-meta__tags" href="/tags/Docker/">Docker</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://fastly.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2022/05/8ce9d753.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">msg=”getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService”问题解决</div></div></a></div><div class="next-post pull-right"><a href="/posts/2022/05/e0ba2ad4.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">通过Autosub为音频视频自动生成字幕文件</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/ava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">叶落花开</div><div class="author-info__description">持续学习，记录后端技术、web技术，以及对认知、技术变现的思考。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">145</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">71</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><div class="card-widget user-map" id="user-map"><div class="item-headline"><i class="fas fa-link"></i><span>友情链接</span></div><div class="item-content"><ul class="entry"><li><a href="/bszs" title="各大高校博士招生信息">各大高校博士招生信息</a></li><li><a target="_blank" rel="noopener" href="https://www.xiaoxinsoft.com" title="小新软件服务">小新软件安装服务</a></li></ul></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Kubernetes-1-24%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">Kubernetes 1.24新特性</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-1-24%E6%96%B0%E7%89%B9%E6%80%A7-1"><span class="toc-number">2.</span> <span class="toc-text">Kubernetes 1.24新特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">3.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">基础环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC"><span class="toc-number">4.0.0.1.</span> <span class="toc-text">服务版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%8E%AF%E5%A2%83"><span class="toc-number">4.0.0.2.</span> <span class="toc-text">初始化环境</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Containerd-%E5%AE%89%E8%A3%85"><span class="toc-number">5.</span> <span class="toc-text">Containerd 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85containerd"><span class="toc-number">5.0.0.1.</span> <span class="toc-text">下载安装containerd</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubeadm-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">Kubeadm 安装配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubectl-%E5%AE%89%E8%A3%85"><span class="toc-number">7.</span> <span class="toc-text">Kubectl 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Master%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">Master节点配置</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 叶落花开</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'freecloud-0gzubvbebcf38cf6',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'freecloud-0gzubvbebcf38cf6',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://fastly.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>